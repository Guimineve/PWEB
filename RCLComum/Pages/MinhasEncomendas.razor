@page "/minhas-encomendas"
@using RCLComum.DTOs
@using RCLComum.Services
@using RCLComum.Interfaces
@inject IApiServices ApiServices
@inject NavigationManager NavManager

<div class="container mt-4 mb-5">
    <h3 class="mb-4 border-start border-4 border-info px-3">Histórico de Encomendas</h3>

    @if (Carregando)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-info" role="status"></div>
            <p>A carregar o histórico...</p>
        </div>
    }
    else if (ListaEncomendas == null || !ListaEncomendas.Any())
    {
        <div class="alert alert-secondary text-center">
            <i class="bi bi-box-seam fs-1"></i>
            <p class="mt-2">Ainda não fizeste nenhuma encomenda.</p>
            <a href="/" class="btn btn-primary mt-2">Ir às Compras</a>
        </div>
    }
    else
    {
        <div class="accordion" id="accordionEncomendas">
            @foreach (var enc in ListaEncomendas)
            {
                <div class="accordion-item border mb-2 shadow-sm rounded">

                    <h2 class="accordion-header" id="heading-@enc.Id">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse-@enc.Id" aria-expanded="false">

                            <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                <div>
                                    <strong>Encomenda #@enc.Id</strong>
                                    <br />
                                    <small class="text-muted">@enc.DataEncomenda.ToShortDateString()</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge @ObterCorEstado(enc.Estado) mb-1">@enc.Estado</span>
                                    <div class="fw-bold text-success">@enc.ValorTotal.ToString("C")</div>
                                </div>
                            </div>

                        </button>
                    </h2>

                    <div id="collapse-@enc.Id" class="accordion-collapse collapse" data-bs-parent="#accordionEncomendas">
                        <div class="accordion-body bg-light">
                            <h6 class="text-muted mb-3">Itens Comprados:</h6>

                            <ul class="list-group">
                                @foreach (var item in enc.Detalhes)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <span>@item.ProdutoNome</span>
                                                <div class="small text-muted">@item.Quantidade x @item.PrecoUnitario.ToString("C")</div>
                                            </div>
                                        </div>
                                        <span class="fw-bold">@item.TotalLinha.ToString("C")</span>
                                    </li>
                                }
                            </ul>

                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Encomenda> ListaEncomendas { get; set; } = new();
    private bool Carregando { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        Carregando = true;

        // ⚠️ ATENÇÃO: Aqui deves ir buscar o ID do utilizador logado.
        // Como ainda não temos AuthProvider completo, vou pôr "1" fixo para testares.
        int userIdTemporario = 1;

        var resultado = await ApiServices.GetMinhasEncomendasAsync(userIdTemporario);

        if (resultado.Sucesso && resultado.Data != null)
        {
            ListaEncomendas = resultado.Data;
            // Ordenar por data (mais recente primeiro)
            ListaEncomendas = ListaEncomendas.OrderByDescending(x => x.DataEncomenda).ToList();
        }

        Carregando = false;
    }

    // Função auxiliar para pintar o estado (Bootstrap classes)
    private string ObterCorEstado(string estado)
    {
        return estado.ToLower() switch
        {
            "pendente" => "bg-warning text-dark",
            "enviado" => "bg-info text-dark",
            "entregue" => "bg-success",
            "cancelado" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}