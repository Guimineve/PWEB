@using RCLComum.DTOs
@using RCLComum.Services
@using RCLComum.Pages
@using Microsoft.AspNetCore.Components
@using RCLComum.Interfaces

@inject IProdutoService ProdutoService
@inject ICardsUtilsServices cardsUtilsServices

<section class="carousel-cards my-3">
    <h5 class="px-3 border-start border-4 border-primary mb-3">2. Produtos Disponíveis</h5>

    @if (TemErro)
    {
        <div class="alert alert-danger mx-3">Ocorreu um erro ao carregar o carrossel. Tenta verificar se a API está ligada.</div>
    }
    else
    {
        <div class="cards-container d-flex overflow-hidden position-relative" style="min-height: 400px;">

            <button @onclick="PreviousCard" disabled="@IsDisabledPrevious" class="btn btn-light shadow-sm position-absolute start-0 top-50 translate-middle-y" style="z-index: 10;">
                <i class="bi bi-chevron-left"></i>
            </button>

            @if (TodosProdutos == null)
            {
                <div class="p-5 w-100 text-center"><div class="spinner-border text-primary"></div></div>
            }
            else if (ProdutosVisiveis.Count == 0)
            {
                <div class="p-5 w-100 text-center text-muted">
                    <i class="bi bi-emoji-frown fs-1"></i>
                    <p>Nenhum produto encontrado.</p>
                </div>
            }
            else
            {
                @foreach (var prod in ProdutosVisiveis)
                {
                    // Lógica segura de margens para o slider funcionar
                    var index = ProdutosVisiveis.IndexOf(prod);
                    var margin = "margin-left: 0%";

                    if (cardsUtilsServices != null &&
                        cardsUtilsServices.MarginLeftSlide != null &&
                        cardsUtilsServices.MarginLeftSlide.Count > index)
                    {
                        margin = cardsUtilsServices.MarginLeftSlide[index];
                    }

                    // AQUI: Assumo que tens um componente chamado CardComponent
                    <CardComponent ProdutoItem="@prod" MarginLeft="@margin" />
                }
            }

            <button @onclick="NextCard" disabled="@IsDisabledNext" class="btn btn-light shadow-sm position-absolute end-0 top-50 translate-middle-y" style="z-index: 10;">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    }
</section>

@code {
    [Parameter] public int CategoriaIdFiltro { get; set; } = 0;

    // Removemos o IApiServices e usamos os @inject lá em cima, é mais limpo.

    private List<Produto>? TodosProdutos { get; set; } // Pode ser null no início
    private List<Produto> ProdutosVisiveis { get; set; } = new();

    private bool IsDisabledNext { get; set; } = false;
    private bool IsDisabledPrevious { get; set; } = false;
    private bool TemErro { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Alteração Principal: Chamada direta ao ProdutoService
            TodosProdutos = await ProdutoService.GetProdutosAsync();

            // Inicializa a lista visível com tudo o que veio da API
            ProdutosVisiveis = TodosProdutos;
            
            await ResetSlider();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro no carrossel: {ex.Message}");
            TemErro = true;
        }
    }

    // Este método é chamado sempre que o parametro CategoriaIdFiltro muda (quando clicas numa categoria)
    protected override async Task OnParametersSetAsync()
    {
        if (TodosProdutos == null || !TodosProdutos.Any()) return;

        try
        {
            if (CategoriaIdFiltro == 0)
            {
                ProdutosVisiveis = TodosProdutos;
            }
            else
            {
                ProdutosVisiveis = TodosProdutos.Where(p => p.CategoriaId == CategoriaIdFiltro).ToList();
            }
            await ResetSlider();
        }
        catch
        {
            // Proteção contra erro de filtro
        }
    }

    private async Task ResetSlider()
    {
        if (cardsUtilsServices == null) return;

        cardsUtilsServices.CountSlide = 0;
        cardsUtilsServices.Index = 0;
        cardsUtilsServices.MarginLeftSlide = new List<string>();

        foreach (var p in ProdutosVisiveis)
        {
            cardsUtilsServices.MarginLeftSlide.Add("margin-left:0%");
        }

        IsDisabledPrevious = true;
        // Só desativa o botão "Próximo" se houver 1 ou 0 produtos
        IsDisabledNext = ProdutosVisiveis.Count <= 1;
        
        await Task.CompletedTask;
    }

    private void PreviousCard()
    {
        if (cardsUtilsServices.CountSlide > 0)
        {
            cardsUtilsServices.MarginLeftSlide[cardsUtilsServices.CountSlide - 1] = "margin-left:0%";
            cardsUtilsServices.CountSlide--;
            IsDisabledNext = false;
        }
        if (cardsUtilsServices.CountSlide == 0) IsDisabledPrevious = true;
    }

    private void NextCard()
    {
        if (cardsUtilsServices.CountSlide < ProdutosVisiveis.Count - 1)
        {
            cardsUtilsServices.CountSlide++;
            // Nota: Este -260px deve ser igual à largura do teu CardComponent + Margem
            cardsUtilsServices.MarginLeftSlide[cardsUtilsServices.CountSlide - 1] = "margin-left:-260px";
            IsDisabledPrevious = false;
        }
        if (cardsUtilsServices.CountSlide >= ProdutosVisiveis.Count - 1) IsDisabledNext = true;
    }
}