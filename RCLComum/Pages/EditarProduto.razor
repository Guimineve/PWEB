@page "/fornecedor/produtos/editar/{Id:int}"
@page "/fornecedor/produtos/criar"
@* Adicionei a rota de criar também *@

@using RCLComum.DTOs
@using RCLComum.Interfaces
@using RCLComum.Services
@inject IProdutoService ProdutoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <h2>@(Id == 0 ? "Novo Produto" : "Editar Produto")</h2>

    <div class="card p-4 shadow-sm">
        @* Usamos EditForm porque facilita a validação *@
        <EditForm Model="produto" OnValidSubmit="Gravar">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Nome do Item</label>
                <InputText class="form-control" @bind-Value="produto.Nome" />
            </div>

            <div class="mb-3">
                <label class="form-label">Detalhe / Descrição</label>
                <InputTextArea class="form-control" @bind-Value="produto.Detalhe" />
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Preço (€)</label>
                    <InputNumber class="form-control" @bind-Value="produto.Preco" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Stock Inicial</label>
                    <InputNumber class="form-control" @bind-Value="produto.Stock" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Categoria</label>
                @* O bind-Value tem de ser um INT (CategoriaId) *@
                <InputSelect class="form-select" @bind-Value="produto.CategoriaId">
                    <option value="0">Selecione uma categoria...</option>
                    @* IDEALMENTE: Aqui fazes um foreach com uma lista de categorias vinda da API *@
                    <option value="1">Frutas</option>
                    <option value="2">Legumes</option>
                    <option value="3">Exóticos</option>
                </InputSelect>
            </div>

            <div class="mb-3 form-check">
                <InputCheckbox class="form-check-input" @bind-Value="produto.Visivel" id="checkVenda" />
                <label class="form-check-label" for="checkVenda">Disponível para Venda</label>
            </div>

            @* --- ZONA DE IMAGEM (A PARTE MAIS DIFÍCIL) --- *@
            <div class="mb-3">
                <label class="form-label">Imagem do Produto</label>

                @* InputFile é o componente nativo do Blazor para uploads *@
                <InputFile OnChange="CarregarImagem" class="form-control" accept=".png, .jpg, .jpeg" />

                @* Pré-visualização da imagem se existir *@
                @if (!string.IsNullOrEmpty(produto.ImagemUrl))
                {
                    <div class="mt-2">
                        <p>Pré-visualização:</p>
                        <img src="@produto.ImagemUrl" style="max-height: 150px;" class="img-thumbnail" />
                    </div>
                }
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Gravar Produto
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Produto produto = new Produto();

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            // Modo Edição: Vai buscar o produto à API
            try
            {
                produto = await ProdutoService.GetProdutoPorIdAsync(Id);
            }
            catch
            {
                // Se der erro (ex: id não existe), volta à lista
                Navigation.NavigateTo("/fornecedor/produtos");
            }
        }
        else
        {
            // Modo Criação: Valores por defeito
            produto.Visivel = true;
        }
    }

    private async Task Gravar()
    {
        // Validação simples
        if (produto.CategoriaId == 0)
        {
            // Podes usar um toast ou alert aqui
            Console.WriteLine("Erro: Escolhe uma categoria");
            return;
        }

        try
        {
            if (Id == 0)
            {
                await ProdutoService.CriarProdutoAsync(produto);
            }
            else
            {
                await ProdutoService.AtualizarProdutoAsync(produto);
            }

            Navigation.NavigateTo("/fornecedor/produtos");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao gravar: {ex.Message}");
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/fornecedor/produtos");
    }

    // Método para converter o ficheiro carregado em Bytes para o DTO
    private async Task CarregarImagem(InputFileChangeEventArgs e)
    {
        var ficheiro = e.File;
        if (ficheiro != null)
        {
            // Limite de tamanho (ex: 5MB)
            var maxTamanho = 5 * 1024 * 1024;

            // Criar um buffer (array de bytes)
            var buffer = new byte[ficheiro.Size];

            // Ler o ficheiro para o buffer
            await ficheiro.OpenReadStream(maxTamanho).ReadAsync(buffer);

            // Atribuir ao DTO
            produto.Imagem = buffer;

            // O ImagemUrl atualiza-se sozinho graças ao código que pusemos no DTO!
        }
    }
}