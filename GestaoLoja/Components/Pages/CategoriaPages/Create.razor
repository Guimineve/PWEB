@page "/categorias/create"

@attribute [Authorize(Roles = "Admin,Funcionario")]

@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@using GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Criar Categoria</PageTitle>

<h1>Criar Nova Categoria</h1>

<hr />
<div class="row">
    <div class="col-md-6">
        <EditForm Model="Categoria" OnValidSubmit="AddCategoria" FormName="create">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label for="nome" class="form-label">Nome:</label>
                <InputText id="nome" @bind-Value="Categoria.Nome" class="form-control" />
                <ValidationMessage For="() => Categoria.Nome" class="text-danger" />
            </div>

            <div class="mb-3">
                <label for="pai" class="form-label">Categoria Pai:</label>
                <InputSelect id="pai" @bind-Value="Categoria.CategoriaPaiId" class="form-select">
                    <option value="">-- Nenhuma (Raiz) --</option>
                    @foreach (var cat in ListaCategorias)
                    {
                        <option value="@cat.Id">@cat.Nome</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Imagem:</label>

                <div class="mb-2 p-2 border rounded text-center" style="width: 150px;">
                    @if (PreviewImagem != null)
                    {
                        <img src="@PreviewImagem" class="img-fluid" style="max-height: 100px;">
                    }
                    else
                    {
                        <img src="/img/noproductstrans.png" class="img-fluid" style="max-height: 100px; opacity: 0.5">
                    }
                </div>

                <InputFile OnChange="CarregarImagem" class="form-control" accept=".png,.jpg,.jpeg" />

                @if (!string.IsNullOrEmpty(ErroImagem))
                {
                    <div class="text-danger small mt-1">@ErroImagem</div>
                }
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-link p-0 me-3" title="Gravar">
                    <img src="/img/saveicon.png" style="height:30px" />
                </button>
                <a href="/categorias" class="btn btn-link p-0" title="Voltar">
                    <img src="/img/backicon.png" style="height:30px" />
                </a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public Categoria Categoria { get; set; } = new();

    private List<Categoria> ListaCategorias = new();
    private string? PreviewImagem;
    private string? ErroImagem;

    private byte[]? ImagemTemporaria;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        ListaCategorias = await context.Categorias.OrderBy(c => c.Nome).ToListAsync();
    }

    private async Task CarregarImagem(InputFileChangeEventArgs e)
    {
        ErroImagem = null;
        var ficheiro = e.File;

        if (ficheiro != null)
        {
            long maxTamanho = 1024 * 1024 * 5;
            if (ficheiro.Size > maxTamanho)
            {
                ErroImagem = "A imagem é demasiado grande (Máx 5MB).";
                return;
            }

            // Validar Tipo
            if (!ficheiro.ContentType.StartsWith("image/"))
            {
                ErroImagem = "Por favor selecione uma imagem válida (PNG, JPG).";
                return;
            }

            try
            {
                // Ler para Array de Bytes
                using var stream = ficheiro.OpenReadStream(maxTamanho);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                ImagemTemporaria = ms.ToArray();

                // Criar Preview
                var base64 = Convert.ToBase64String(ImagemTemporaria);
                PreviewImagem = $"data:{ficheiro.ContentType};base64,{base64}";
            }
            catch (Exception ex)
            {
                ErroImagem = "Erro ao ler imagem: " + ex.Message;
            }
        }
    }

    public async Task AddCategoria()
    {
        using var context = DbFactory.CreateDbContext();

        // Passar a imagem temporária para a entidade antes de gravar
        if (ImagemTemporaria != null)
        {
            Categoria.Imagem = ImagemTemporaria;
        }

        context.Categorias.Add(Categoria);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/categorias");
    }
}