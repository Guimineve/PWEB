@page "/produtos"
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@using GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@implements IAsyncDisposable

<PageTitle>Gestão de Produtos</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="m-0 fw-bold text-primary">Gestão de Produtos</h3>
        <a href="produtos/create" class="btn btn-link p-0" title="Novo Produto">
            <img src="/img/novo.png" style="height:50px" alt="Novo" />
        </a>
    </div>

    <div class="card bg-light border-0 mb-4">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Pesquisar</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Nome ou detalhe..."
                               @bind="FiltroTexto" @bind:event="oninput" @onkeyup="CarregarDados" />
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Categoria</label>
                    <select class="form-select" @bind="FiltroCategoriaId" @bind:after="CarregarDados">
                        <option value="0">Todas as Categorias</option>
                        @foreach (var cat in ListaCategorias)
                        {
                            <option value="@cat.Id">@cat.Nome</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Modo de Entrega</label>
                    <select class="form-select" @bind="FiltroModoEntregaId" @bind:after="CarregarDados">
                        <option value="0">Todos</option>
                        @foreach (var modo in ListaModosEntrega)
                        {
                            <option value="@modo.Id">@modo.Nome</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Estado</label>
                    <select class="form-select" @bind="FiltroEstado" @bind:after="CarregarDados">
                        <option value="">Todos</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Aprovado">Aprovado</option>
                        <option value="Rejeitado">Rejeitado</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Tipo</label>
                    <select class="form-select" @bind="FiltroTipo" @bind:after="CarregarDados">
                        <option value="">Todos</option>
                        <option value="Venda">Venda</option>
                        <option value="Aluguer">Aluguer</option>
                        <option value="Listagem">Listagem</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">Ordenar por</label>
                    <select class="form-select" @bind="OrdemOrdenacao" @bind:after="CarregarDados">
                        <option value="recente">Mais Recentes</option>
                        <option value="nome_az">Nome (A-Z)</option>
                        <option value="nome_za">Nome (Z-A)</option>
                        <option value="preco_min">Preço (Menor &rarr; Maior)</option>
                        <option value="preco_max">Preço (Maior &rarr; Menor)</option>
                        <option value="stock_min">Stock (Menor &rarr; Maior)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (ProdutosPaginados == null)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p>A carregar produtos...</p>
        </div>
    }
    else if (!ProdutosPaginados.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-search fs-1 text-muted"></i>
            <h5 class="mt-3">Nenhum produto encontrado.</h5>
            <p>Tente alterar os filtros de pesquisa.</p>
        </div>
    }
    else
    {
        <div class="table-responsive bg-white rounded shadow-sm p-3">
            <table class="table table-hover align-middle mb-0 text-center">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;">Img</th>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Preço</th>
                        <th>Margem de Lucro</th>
                        <th>Preco Final</th>
                        <th>Stock</th>
                        <th>Modo de Entrega</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var prod in ProdutosPaginados)
                    {
                        <tr>
                            <td>
                                @if (prod.Imagem != null && prod.Imagem.Length > 0)
                                {
                                    <img src="data:image/png;base64,@(Convert.ToBase64String(prod.Imagem))"
                                         class="rounded" style="width: 40px; height: 40px; object-fit: cover;" />
                                }
                                else
                                {
                                    <img src="/img/noproductstrans.png" style="width: 40px; opacity: 0.5" />
                                }
                            </td>
                            <td class="fw-bold">@prod.Nome</td>
                            <td class="text-muted small">@(prod.Categoria?.Nome ?? "-")</td>
                            <td class="text-success fw-bold">@prod.Preco.ToString("C2")</td>
                            <td>@prod.MargemLucro.ToString("0.##")%</td>
                            <td>
                                @{
                                    var precoFinal = prod.Preco + (prod.Preco * (prod.MargemLucro / 100));
                                    @precoFinal.ToString("C")
                                }
                            </td>
                            <td>
                                @if (prod.Stock < 5)
                                {
                                    <span class="badge bg-danger">@prod.Stock</span>
                                }
                                else
                                {
                                    <span>@prod.Stock</span>
                                }
                            </td>

                            <td>
                                <span class="badge bg-secondary">@prod.ModoEntrega?.Nome</span>
                            </td>

                            <td>
                                @if (prod.EstadoAprovacao == "Aprovado")
                                {
                                    <span class="badge bg-success">Aprovado</span>
                                }
                                else if (prod.EstadoAprovacao == "Rejeitado")
                                {
                                    <span class="badge bg-danger">Rejeitado</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Pendente</span>
                                }
                            </td>

                            <td>
                                @if (prod.Tipo == "Venda")
                                {
                                    <span class="badge bg-primary">Venda</span>
                                }
                                else if (prod.Tipo == "Aluguer")
                                {

                                    <span class="badge bg-info text-dark">Aluguer</span>
                                }
                                else
                                {

                                    <span class="badge bg-secondary">Listagem</span>
                                }
                            </td>

                            <td class="text-end" style="white-space: nowrap;">
                                <a href="produtos/edit?id=@prod.Id" title="Editar" class="me-2">
                                    <img src="/img/editicon.png" style="height:30px" alt="Editar" />
                                </a>

                                <a href="produtos/details?id=@prod.Id" title="Detalhes" class="me-2">
                                    <img src="/img/detailsicon.png" style="height:30px" alt="Detalhes" />
                                </a>

                                <a href="produtos/delete?id=@prod.Id" title="Apagar">
                                    <img src="/img/deleteicon.png" style="height:30px" alt="Apagar" />
                                </a>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <span class="text-muted small">
                A mostrar @ProdutosPaginados.Count registos (Página @PaginaAtual de @TotalPaginas)
            </span>
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm"
                        disabled="@(PaginaAtual == 1)"
                        @onclick="PaginaAnterior">
                    <i class="bi bi-chevron-left"></i> Anterior
                </button>
                <button class="btn btn-outline-secondary btn-sm"
                        disabled="@(PaginaAtual == TotalPaginas || TotalPaginas == 0)"
                        @onclick="ProximaPagina">
                    Próximo <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    }
</div>

@code {
    private ApplicationDbContext context = default!;

    // Dados Principais
    private List<Produto>? ProdutosPaginados;
    private List<Categoria> ListaCategorias = new();
    private List<ModoEntrega> ListaModosEntrega = new();

    // Variáveis de Filtro
    private string FiltroTexto = "";
    private int FiltroCategoriaId = 0;
    private int FiltroModoEntregaId = 0;
    private string FiltroEstado = "";
    private string FiltroTipo = "";

    private string OrdemOrdenacao = "recente";

    // Variáveis de Paginação
    private int PaginaAtual = 1;
    private int TamanhoPagina = 10; // Quantos produtos por página
    private int TotalPaginas = 1;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        ListaCategorias = await context.Categorias.OrderBy(c => c.Nome).ToListAsync();
        ListaModosEntrega = await context.ModosEntrega.OrderBy(m => m.Nome).ToListAsync();
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        var query = context.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.ModoEntrega)
            .AsQueryable();

        // Filtro Texto
        if (!string.IsNullOrEmpty(FiltroTexto))
        {
            query = query.Where(p => p.Nome.Contains(FiltroTexto) || p.Detalhe.Contains(FiltroTexto));
        }

        // Filtro Categoria
        if (FiltroCategoriaId > 0)
        {
            var idsFamília = await GetCategoriaEFilhasIdsAsync(FiltroCategoriaId);
            query = query.Where(p => idsFamília.Contains(p.CategoriaId));
        }

        // Filtro Modo de Disponibilização
        if (FiltroModoEntregaId > 0)
        {
            query = query.Where(p => p.ModoEntregaId == FiltroModoEntregaId);
        }

        // Filtro Estado de Aprovação
        if (!string.IsNullOrEmpty(FiltroEstado))
        {
            query = query.Where(p => p.EstadoAprovacao == FiltroEstado);
        }

        // Filtro Tipo
        if (!string.IsNullOrEmpty(FiltroTipo))
        {
            query = query.Where(p => p.Tipo == FiltroTipo);
        }

        // Aplicar Ordenação
        query = OrdemOrdenacao switch
        {
            "nome_az" => query.OrderBy(p => p.Nome),
            "nome_za" => query.OrderByDescending(p => p.Nome),
            "preco_min" => query.OrderBy(p => p.Preco),
            "preco_max" => query.OrderByDescending(p => p.Preco),
            "stock_min" => query.OrderBy(p => p.Stock),
            _ => query.OrderByDescending(p => p.Id) // Recentes
        };

        // Calcular Total de Páginas
        int totalItens = await query.CountAsync();
        TotalPaginas = (int)Math.Ceiling(totalItens / (double)TamanhoPagina);
        if (TotalPaginas == 0) TotalPaginas = 1;

        if (PaginaAtual > TotalPaginas) PaginaAtual = TotalPaginas;

        // Executar Paginação e Trazer Dados
        ProdutosPaginados = await query
            .Skip((PaginaAtual - 1) * TamanhoPagina)
            .Take(TamanhoPagina)
            .ToListAsync();
    }

    private async Task PaginaAnterior()
    {
        if (PaginaAtual > 1)
        {
            PaginaAtual--;
            await CarregarDados();
        }
    }

    private async Task ProximaPagina()
    {
        if (PaginaAtual < TotalPaginas)
        {
            PaginaAtual++;
            await CarregarDados();
        }
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    private async Task<List<int>> GetCategoriaEFilhasIdsAsync(int categoriaPaiId)
    {
        using var context = await DbFactory.CreateDbContextAsync();

        var todasCategorias = await context.Categorias.ToListAsync();

        var idsParaFiltrar = new List<int>();

        void AdicionarFilhas(int idPai)
        {
            idsParaFiltrar.Add(idPai); 

            var filhas = todasCategorias.Where(c => c.CategoriaPaiId == idPai).Select(c => c.Id);

            foreach (var filhaId in filhas)
            {
                AdicionarFilhas(filhaId);
            }
        }

        AdicionarFilhas(categoriaPaiId);
        return idsParaFiltrar;
    }
}