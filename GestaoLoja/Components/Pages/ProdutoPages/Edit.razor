@page "/produtos/edit"

@attribute [Authorize(Roles = "Admin,Funcionario")]

@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@using GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Editar Produto</PageTitle>

<h1>Editar Produto</h1>
<hr />

@if (Produto is null)
{
	<p><em>A carregar...</em></p>
}
else
{
	<div class="row">
		<div class="col-md-8">
			<EditForm Model="Produto" OnValidSubmit="UpdateProduto" FormName="edit" Enhance>
				<DataAnnotationsValidator />
				<ValidationSummary class="text-danger" />

				<input type="hidden" name="Produto.Id" value="@Produto.Id" />

				<div class="row">
					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label">Nome:</label>
							<InputText @bind-Value="Produto.Nome" class="form-control" />
							<ValidationMessage For="() => Produto.Nome" class="text-danger" />
						</div>

						<div class="mb-3">
							<label class="form-label">Detalhe:</label>
							<InputTextArea @bind-Value="Produto.Detalhe" class="form-control" rows="3" />
							<ValidationMessage For="() => Produto.Detalhe" class="text-danger" />
						</div>

						<div class="row">
							<div class="col-6 mb-3">
								<label class="form-label">Preço (€):</label>
								<InputNumber @bind-Value="Produto.Preco" class="form-control" />
								<ValidationMessage For="() => Produto.Preco" class="text-danger" />
							</div>
							<div class="col-6 mb-3">
								<label class="form-label">Stock:</label>
								<InputNumber @bind-Value="Produto.Stock" class="form-control" />
								<ValidationMessage For="() => Produto.Stock" class="text-danger" />
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Margem de Lucro:</label>
							<div class="input-group">
								<InputNumber @bind-Value="Produto.MargemLucro" class="form-control border-success text-end"/>
								<span class="input-group-text">%</span>
							</div>
							<div class="form-text small">
								Preço final: <br />
								@{
									var precoFinal = Produto.Preco + (Produto.Preco * (Produto.MargemLucro / 100));
									<span class="text-dark fw-bold">Preço Final Est.: @precoFinal.ToString("C")</span>
								}
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Tipo de Negócio:</label>
							<InputSelect @bind-Value="Produto.Tipo" class="form-select">
								<option value="">-- Selecione --</option>
								<option value="Venda">Venda</option>
								<option value="Aluguer">Aluguer</option>
								<option value="Listagem">Listagem</option>
							</InputSelect>
							<ValidationMessage For="() => Produto.Tipo" class="text-danger" />
						</div>
					</div>

					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label">Categoria:</label>
							<InputSelect @bind-Value="Produto.CategoriaId" class="form-select">
								<option value="0">-- Selecione --</option>
								@foreach (var cat in ListaCategorias)
								{
									<option value="@cat.Id">@cat.Nome</option>
								}
							</InputSelect>
						</div>

						<div class="mb-3">
							<label class="form-label">Modo de Entrega:</label>
							<InputSelect @bind-Value="Produto.ModoEntregaId" class="form-select">
								<option value="0">-- Selecione --</option>
								@foreach (var modo in ListaModos)
								{
									<option value="@modo.Id">@modo.Nome</option>
								}
							</InputSelect>
						</div>

						<div class="mb-3 form-check form-switch">
							<InputCheckbox @bind-Value="Produto.Visivel" class="form-check-input" id="visivel" />
							<label class="form-check-label" for="visivel">Visível na Loja</label>
						</div>

						<div class="mb-3">
							<label class="form-label">Estado Aprovação:</label>
							<InputSelect @bind-Value="Produto.EstadoAprovacao" class="form-select">
								<option value="Pendente">Pendente</option>
								<option value="Aprovado">Aprovado</option>
								<option value="Rejeitado">Rejeitado</option>
							</InputSelect>
						</div>

						<div class="mb-3 p-3 border rounded bg-light">
							<label class="form-label fw-bold">Imagem:</label>
							<div class="text-center mb-2">
								@if (PreviewImagem != null)
								{
									<img src="@PreviewImagem" class="img-fluid rounded" style="max-height: 150px;">
								}
								else
								{
									<img src="/img/noproductstrans.png" class="img-fluid" style="max-height: 100px; opacity: 0.5">
								}
							</div>
							<InputFile OnChange="CarregarImagem" class="form-control" accept=".png,.jpg,.jpeg" />
							@if (!string.IsNullOrEmpty(ErroImagem))
							{
								<div class="text-danger small mt-1">@ErroImagem</div>
							}
						</div>
					</div>
				</div>

				<div class="mt-4">
					<button type="submit" class="btn btn-link p-0 me-3" title="Gravar">
						<img src="/img/saveicon.png" style="height:40px" />
					</button>
					<a href="/produtos" class="btn btn-link p-0" title="Voltar">
						<img src="/img/backicon.png" style="height:40px" />
					</a>
				</div>
			</EditForm>
		</div>
	</div>
}

@code {
	[SupplyParameterFromQuery]
	public int Id { get; set; }

	[SupplyParameterFromForm]
	public Produto? Produto { get; set; }

	private List<Categoria> ListaCategorias = new();
	private List<ModoEntrega> ListaModos = new();

	private string? PreviewImagem;
	private string? ErroImagem;
	private byte[]? NovaImagemBytes;

	protected override async Task OnInitializedAsync()
	{
		using var context = DbFactory.CreateDbContext();

		Produto ??= await context.Produtos.FirstOrDefaultAsync(m => m.Id == Id);

		if (Produto is null)
		{
			NavigationManager.NavigateTo("notfound");
			return;
		}

		ListaCategorias = await context.Categorias.OrderBy(c => c.Nome).ToListAsync();
		ListaModos = await context.ModosEntrega.OrderBy(m => m.Nome).ToListAsync();

		if (Produto.Imagem != null && Produto.Imagem.Length > 0)
		{
			var base64 = Convert.ToBase64String(Produto.Imagem);
			PreviewImagem = $"data:image/png;base64,{base64}";
		}
	}

	private async Task CarregarImagem(InputFileChangeEventArgs e)
	{
		ErroImagem = null;
		var ficheiro = e.File;
		if (ficheiro != null)
		{
			if (ficheiro.Size > 1024 * 1024 * 5)
			{
				ErroImagem = "Imagem demasiado grande.";
				return;
			}

			try
			{
				using var stream = ficheiro.OpenReadStream(1024 * 1024 * 5);
				using var ms = new MemoryStream();
				await stream.CopyToAsync(ms);
				NovaImagemBytes = ms.ToArray();
				PreviewImagem = $"data:{ficheiro.ContentType};base64,{Convert.ToBase64String(NovaImagemBytes)}";
			}
			catch (Exception ex) { ErroImagem = ex.Message; }
		}
	}

	public async Task UpdateProduto()
	{
		using var context = DbFactory.CreateDbContext();

		// Produto da Base de Dados
		var produtoNaBD = await context.Produtos.FindAsync(Produto!.Id);

		if (produtoNaBD is null)
		{
			NavigationManager.NavigateTo("notfound");
			return;
		}

		// Atualizar os dados
		produtoNaBD.Nome = Produto.Nome;
		produtoNaBD.Detalhe = Produto.Detalhe;
		produtoNaBD.Preco = Produto.Preco;
		produtoNaBD.MargemLucro = Produto.MargemLucro;
		produtoNaBD.Stock = Produto.Stock;
		produtoNaBD.Tipo = Produto.Tipo;
		produtoNaBD.Visivel = Produto.Visivel;
		produtoNaBD.EstadoAprovacao = Produto.EstadoAprovacao;

		// Atualizar as Chaves Estrangeiras
		produtoNaBD.CategoriaId = Produto.CategoriaId;
		produtoNaBD.ModoEntregaId = Produto.ModoEntregaId;

		// Atualizar Imagem
		if (NovaImagemBytes != null)
		{
			produtoNaBD.Imagem = NovaImagemBytes;
		}

		// Gravar
		await context.SaveChangesAsync();
		NavigationManager.NavigateTo("/produtos");
	}

	bool ProdutoExists(int id)
	{
		using var context = DbFactory.CreateDbContext();
		return context.Produtos.Any(e => e.Id == id);
	}
}