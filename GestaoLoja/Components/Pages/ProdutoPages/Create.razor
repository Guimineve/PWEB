@page "/produtos/create"
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@using GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Criar Produto</PageTitle>

<h1>Criar Novo Produto</h1>
<hr />

<div class="row">
    <div class="col-md-8">
        <EditForm Model="Produto" OnValidSubmit="AddProduto" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Nome:</label>
                        <InputText @bind-Value="Produto.Nome" class="form-control" />
                        <ValidationMessage For="() => Produto.Nome" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Detalhe/Descrição:</label>
                        <InputTextArea @bind-Value="Produto.Detalhe" class="form-control" rows="3" />
                        <ValidationMessage For="() => Produto.Detalhe" class="text-danger" />
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Preço (€):</label>
                            <InputNumber @bind-Value="Produto.Preco" class="form-control" />
                            <ValidationMessage For="() => Produto.Preco" class="text-danger" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Stock:</label>
                            <InputNumber @bind-Value="Produto.Stock" class="form-control" />
                            <ValidationMessage For="() => Produto.Stock" class="text-danger" />
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Finalidade:</label>
                        <InputSelect @bind-Value="Produto.Tipo" class="form-select">
                            <option value="">-- Selecione --</option>
                            <option value="Venda">Venda (Produto Final)</option>
                            <option value="Aluguer">Aluguer (Preço p/ dia)</option>
                            <option value="Listagem">Listagem (Coleção Privada)</option>
                        </InputSelect>
                        <ValidationMessage For="() => Produto.Tipo" class="text-danger" />
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Categoria:</label>
                        <InputSelect @bind-Value="Produto.CategoriaId" class="form-select">
                            <option value="0">-- Selecione a Categoria --</option>
                            @foreach (var cat in ListaCategorias)
                            {
                                <option value="@cat.Id">@cat.Nome</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Produto.CategoriaId" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Modo de Entrega:</label>
                        <InputSelect @bind-Value="Produto.ModoEntregaId" class="form-select">
                            <option value="0">-- Selecione o Modo --</option>
                            @foreach (var modo in ListaModos)
                            {
                                <option value="@modo.Id">@modo.Nome</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Produto.ModoEntregaId" class="text-danger" />
                    </div>

                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="form-label fw-bold">Imagem do Produto:</label>
                        <div class="text-center mb-2">
                            @if (PreviewImagem != null)
                            {
                                <img src="@PreviewImagem" class="img-fluid rounded" style="max-height: 150px;">
                            }
                            else
                            {
                                <img src="/img/noproductstrans.png" class="img-fluid" style="max-height: 100px; opacity: 0.5">
                            }
                        </div>
                        <InputFile OnChange="CarregarImagem" class="form-control" accept=".png,.jpg,.jpeg" />
                        @if (!string.IsNullOrEmpty(ErroImagem))
                        {
                            <div class="text-danger small mt-1">@ErroImagem</div>
                        }
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-link p-0 me-3" title="Gravar">
                    <img src="/img/saveicon.png" style="height:40px" />
                </button>
                <a href="/produtos" class="btn btn-link p-0" title="Voltar">
                    <img src="/img/backicon.png" style="height:40px" />
                </a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public Produto Produto { get; set; } = new() { Visivel = true };

    // Listas para os Dropdowns
    private List<Categoria> ListaCategorias = new();
    private List<ModoEntrega> ListaModos = new();

    // Auxiliares Imagem
    private string? PreviewImagem;
    private string? ErroImagem;
    private byte[]? ImagemTemporaria;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Carregar listas para preencher os <select>
        ListaCategorias = await context.Categorias.OrderBy(c => c.Nome).ToListAsync();
        ListaModos = await context.ModosEntrega.OrderBy(m => m.Nome).ToListAsync();
    }

    private async Task CarregarImagem(InputFileChangeEventArgs e)
    {
        ErroImagem = null;
        var ficheiro = e.File;
        if (ficheiro != null)
        {
            if (ficheiro.Size > 1024 * 1024 * 5)
            {
                ErroImagem = "Imagem demasiado grande.";
                return;
            }
            try
            {
                using var stream = ficheiro.OpenReadStream(1024 * 1024 * 5);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                ImagemTemporaria = ms.ToArray();
                PreviewImagem = $"data:{ficheiro.ContentType};base64,{Convert.ToBase64String(ImagemTemporaria)}";
            }
            catch (Exception ex) { ErroImagem = ex.Message; }
        }
    }

    public async Task AddProduto()
    {
        if (Produto.CategoriaId == 0 || Produto.ModoEntregaId == 0)
        {
            ErroImagem = "Tem de selecionar uma Categoria e um Modo de Entrega.";
            return;
        }

        if (string.IsNullOrEmpty(Produto.Tipo))
        {
            ErroImagem = "Tem de selecionar se é para Venda, Aluguer ou Listagem.";
            return;
        }

        using var context = DbFactory.CreateDbContext();

        if (ImagemTemporaria != null)
        {
            Produto.Imagem = ImagemTemporaria;
        }

        Produto.Visivel = false;
        Produto.EstadoAprovacao = "Pendente";
        Produto.MargemLucro = 0;

        context.Produtos.Add(Produto);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/produtos");
    }
}