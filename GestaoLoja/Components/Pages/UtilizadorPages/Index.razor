@page "/utilizadores"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entities
@using System.Security.Claims
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Admin,Funcionario")]

<PageTitle>Gestão de Utilizadores</PageTitle>

<div class="container-fluid mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3 class="m-0 fw-bold text-primary">Gestão de Utilizadores</h3>
	</div>

	<div class="card bg-light border-0 mb-4">
		<div class="card-body p-3">
			<div class="row g-3">
				<div class="col-md-4">
					<label class="form-label small text-muted fw-bold">Pesquisar</label>
					<div class="input-group">
						<span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
						<input type="text" class="form-control" placeholder="Nome ou Email..."
							   @bind="FiltroTexto" @bind:event="oninput" />
					</div>
				</div>

				<div class="col-md-4">
					<label class="form-label small text-muted fw-bold">Tem o Perfil</label>
					<select class="form-select" @bind="FiltroRole">
						<option value="">Qualquer</option>
						<option value="Admin">Admin</option>
						<option value="Funcionario">Funcionário</option>
						<option value="Cliente">Cliente</option>
						<option value="Fornecedor">Fornecedor</option>
					</select>
				</div>

				<div class="col-md-4">
					<label class="form-label small text-muted fw-bold">Estado</label>
					<select class="form-select" @bind="FiltroEstado">
						<option value="">Todos</option>
						<option value="Ativo">Ativo</option>
						<option value="Pendente">Pendente</option>
						<option value="Inativo">Inativo</option>
					</select>
				</div>
			</div>
		</div>
	</div>

	@if (ListaUtilizadores == null)
	{
		<p>A carregar...</p>
	}
	else
	{
		<div class="table-responsive bg-white rounded shadow-sm p-3">
			<table class="table table-hover align-middle mb-0 text-center">
				<thead class="table-light">
					<tr>
						<th class="text-start ps-4">Utilizador</th>
						<th>Roles</th>
						<th>Estado</th>
						<th class="text-end">Ações</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var user in GetUsersFiltrados())
					{
						bool eOProprio = user.Id == CurrentUserId;
						var rolesDesteUser = UserRoles.ContainsKey(user.Id) ? UserRoles[user.Id] : new List<string>();

						bool alvoEAdminOuFunc = rolesDesteUser.Any(r => r == "Admin" || r == "Funcionario");

						bool possoEditar = false;
						if (EuSouAdmin)
						{
							possoEditar = !eOProprio;
						}
						else
						{
							possoEditar = !alvoEAdminOuFunc;
						}

						<tr class="@(eOProprio ? "table-warning" : "")">

							<td class="text-start ps-4">
								<div class="fw-bold">@user.Nome</div>
								<div class="small text-muted">@user.Email</div>
							</td>

							<td>
								@foreach (var role in rolesDesteUser)
								{
									@if (role == "Admin")
									{
										<span class="badge bg-danger me-1">Administrador</span>
									}
									else if (role == "Funcionario")
									{

										<span class="badge bg-primary me-1">Funcionário</span>
									}
									else if (role == "Fornecedor")
									{

										<span class="badge bg-info text-dark me-1">Fornecedor</span>
									}
									else
									{

										<span class="badge bg-secondary me-1">Cliente</span>
									}
								}
								@if (!rolesDesteUser.Any())
								{
									<span class="text-muted small">-</span>
								}
							</td>

							<td>
								@if (user.EstadoConta == "Ativo")
								{
									<span class="badge bg-success">Ativo</span>
								}
								else if (user.EstadoConta == "Pendente")
								{

									<span class="badge bg-warning text-dark">Pendente</span>
								}
								else
								{

									<span class="badge bg-danger">Inativo</span>
								}
							</td>

							<td class="text-end" style="white-space: nowrap;">
								@if (possoEditar)
								{
									<a href="utilizadores/edit?id=@user.Id" class="me-2" title="Gerir">
										<img src="/img/editicon.png" style="height:30px" />
									</a>

								}
								else
								{
									<span class="d-inline-block me-2" style="opacity: 0.3; filter: grayscale(100%);">
										<img src="/img/editicon.png" style="height:30px" />
									</span>
								}
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	}
</div>

@code {
	private List<ApplicationUser>? ListaUtilizadores;
	private Dictionary<string, IList<string>> UserRoles = new();

	private string FiltroTexto = "";
	private string FiltroRole = "";
	private string FiltroEstado = "";

	private string CurrentUserId = "";
	private bool EuSouAdmin = false;

	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var userPrincipal = authState.User;
		CurrentUserId = userPrincipal.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
		EuSouAdmin = userPrincipal.IsInRole("Admin");

		ListaUtilizadores = await UserManager.Users.ToListAsync();

		foreach (var user in ListaUtilizadores)
		{
			var roles = await UserManager.GetRolesAsync(user);
			UserRoles[user.Id] = roles;
		}
	}

	private IEnumerable<ApplicationUser> GetUsersFiltrados()
	{
		if (ListaUtilizadores == null) return Enumerable.Empty<ApplicationUser>();

		var query = ListaUtilizadores.AsEnumerable();

		if (!string.IsNullOrEmpty(FiltroTexto))
		{
			query = query.Where(u =>
				(u.Nome?.Contains(FiltroTexto, StringComparison.OrdinalIgnoreCase) ?? false) ||
				(u.Email?.Contains(FiltroTexto, StringComparison.OrdinalIgnoreCase) ?? false));
		}
		if (!string.IsNullOrEmpty(FiltroRole))
		{
			query = query.Where(u => UserRoles.ContainsKey(u.Id) && UserRoles[u.Id].Contains(FiltroRole));
		}

		if (!string.IsNullOrEmpty(FiltroEstado))
		{
			query = query.Where(u => u.EstadoConta == FiltroEstado);
		}

		return query;
	}
}